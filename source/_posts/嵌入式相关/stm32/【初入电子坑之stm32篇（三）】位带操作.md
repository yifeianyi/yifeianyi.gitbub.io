---
title: 【初入电子坑之stm32篇（三）】位带操作
mathjax: true
date: 2021-01-16 18:56:05
tags: stm32
categories: 电子
---

## 前言

> 由寄存器编程我们可以知道，很多时候我们需要修改的值的其实只有单独的某一位，那在stm32中怎么实现对单独一个位的操作呢？未带操作！

<!--more-->

### 问题讨论范围

- 什么是位带操作？
- 位带操作有什么意义？
- 怎么进行位带操作？

## 正文

### 位带操作

位带操作(也叫位段操作)，可以理解为允许进行位操作的地带。

由于底层电路设计的原因，stm32单片机单次可操作的存储单元是4Byte，所以想要进行位操作的话需要进行一些转化，这种转化机制只有部分内存地址设置了，而有这种转化机制的区域就叫**位带区**。

![位带示意图](位带示意图.png)



上图就是支持位带操作的区域示意图。

我们对比下外设的地址映射图：

![内存起始位置](内存起始位置.png)

![内存末位置](内存末位置.png)

可以看到所有片上外设的地址都包含在内了。所以我们操作外设的时候都可以进行位带操作。

而这个转化机制是怎么实现的呢？

很简单，既然单次操作只能同时控制4个byte，那么我们把1Bit当4byte使用，其中只有最低位的Bit操作有效不就可以了嘛。

事实上，官方也是怎么设计的。从上面的位带适应图可以看到有个叫**位带别名区**的东西，它就是1Bit膨胀成4Byte后的内存区域。

我们通过操作这块区域的地址，就能等效成操作位带区域的某一位了。

### 位带操作的意义

一开始看位带操作的时候，有种鸡肋的感觉。

原因有二：

- 腾出远多于实际需要操作的外设、SRAM内存，只为了可以单独操作极少部分内存的一个bit，这值得吗？
- 官方既然给出了固件库可以，库函数可以对单独的某一位进行修改，为什么又还需要用位带操作？

在查阅了很多资料后，得出了一个勉强可以说服自己的答案：

> 固件库的本质是调用已经封装好的函数，而函数的运行效率比寄存器操作要慢。
>
> 而直接使用寄存器操作的话，会有些不便、容易出错，所以位带操作就是这两者中的折中方案了。

我也不知道这个答案对不对，为了可能需要节省的性能而专门腾出辣么多内存干这件事真的值得吗？也许是我太菜还没不能理解它的珍贵之处吧。

***

未完待续~~~